<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è£…å¤‡å¼ºåŒ–è®¡ç®—å™¨</title>
    <script src="tailwindcss.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE'
                    }
                }
            }
        }
    </script>
    <style>
        /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ */
        .slider::-webkit-slider-thumb {
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #5D5CDE;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #5D5CDE;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* æç¤ºå®¹å™¨è¿‡æ¸¡æ•ˆæœ */
        #toast-container.show {
            transform: translateY(0);
            opacity: 1;
        }

        #toast-container.hide {
            transform: translateY(-100%);
            opacity: 0;
        }
    </style>
</head>

<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white transition-colors duration-200">
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <div id="toast-container" class="fixed top-0 left-0 right-0 z-50 p-4 transition-all duration-500 transform hide">
        <div id="toast-message" class="mx-auto max-w-lg p-3 rounded-lg text-center font-bold shadow-lg"></div>
    </div>

    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 dark:from-gray-900 dark:to-gray-800">
        <div class="container mx-auto px-4 py-8">
            <div class="flex flex-col md:flex-row md:flex-row-reverse gap-8">
                <div class="md:w-2/5 flex flex-col gap-8">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">è®¾å®šç›®æ ‡</h3>
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">ç›®æ ‡æ€»å’Œ(%)</label>
                                <input type="number" id="targetSum" value="126" min="0" max="200"
                                    class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å…ƒå®/çµç‰æ¯”ä¾‹</label>
                                <input type="number" id="yuanbaoRatio" value="30" min="1"
                                    class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">å…‰æ•ˆé€‰æ‹©</label>
                                <select id="lightEffect"
                                    class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                                    <option value="20">å…¨éƒ¨</option>
                                    <option value="12">é»„å…‰ï¼ˆæœ€é«˜12ï¼‰</option>
                                    <option value="15">è“å…‰ï¼ˆæœ€é«˜15ï¼‰</option>
                                    <option value="18">çº¢å…‰ï¼ˆæœ€é«˜18ï¼‰</option>
                                    <option value="20">ç´«å…‰ï¼ˆæœ€é«˜20ï¼‰</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">å½“å‰æ€»å’Œ(%)</div>
                                    <div class="text-2xl font-bold text-primary" id="currentSum">0</div>
                                </div>
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4">
                                    <div class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">è¿˜éœ€å¼ºåŒ–(%)</div>
                                    <div class="text-2xl font-bold text-red-500" id="needSum">126</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 flex-1">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">ğŸ’ æ€§ä»·æ¯”æ¨è</h3>
                        <div class="grid grid-cols-1 md:grid-cols-1 gap-4" id="recommendations">
                        </div>
                    </div>
                </div>

                <div class="md:w-3/5">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 h-full">
                        <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-6">è£…å¤‡å¼ºåŒ–è®¾ç½®</h3>
                        <div class="space-y-4" id="equipmentList">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è£…å¤‡æ•°æ®
        const equipmentData = {
            "ç­‰çº§1": { "å…ƒå®": "40", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "4" },
            "ç­‰çº§2": { "å…ƒå®": "95", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "4" },
            "ç­‰çº§3": { "å…ƒå®": "130", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "5" },
            "ç­‰çº§4": { "å…ƒå®": "370", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "5" },
            "ç­‰çº§5": { "å…ƒå®": "595", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "5" },
            "ç­‰çº§6": { "å…ƒå®": "780", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "6" },
            "ç­‰çº§7": { "å…ƒå®": "990", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "6" },
            "ç­‰çº§8": { "å…ƒå®": "1270", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "6" },
            "ç­‰çº§9": { "å…ƒå®": "1575", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "7" },
            "ç­‰çº§10": { "å…ƒå®": "1910", "çµç‰": "0", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "7" },
            "ç­‰çº§11": { "å…ƒå®": "0", "çµç‰": "190", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "7" },
            "ç­‰çº§12": { "å…ƒå®": "0", "çµç‰": "285", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "8" },
            "ç­‰çº§13": { "å…ƒå®": "0", "çµç‰": "420", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "8" },
            "ç­‰çº§14": { "å…ƒå®": "0", "çµç‰": "595", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "8" },
            "ç­‰çº§15": { "å…ƒå®": "0", "çµç‰": "805", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "9" },
            "ç­‰çº§16": { "å…ƒå®": "0", "çµç‰": "1515", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "9" },
            "ç­‰çº§17": { "å…ƒå®": "0", "çµç‰": "2050", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "9" },
            "ç­‰çº§18": { "å…ƒå®": "0", "çµç‰": "2765", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "10" },
            "ç­‰çº§19": { "å…ƒå®": "0", "çµç‰": "3835", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "10" },
            "ç­‰çº§20": { "å…ƒå®": "0", "çµç‰": "5040", "å¼€å§‹å¼ºåŒ–": "2", "ç»“æŸå¼ºåŒ–": "10" }
        };

        // å½“å‰å¼ºåŒ–æ•°å€¼
        let currentValues = {};
        // è®¡æ—¶å™¨ï¼Œç”¨äºè‡ªåŠ¨éšè—æç¤º
        let toastTimeout;

        // åˆå§‹åŒ–
        function init() {
            // åˆå§‹åŒ–å½“å‰æ•°å€¼ä¸º0
            for (let i = 1; i <= 20; i++) {
                currentValues[`ç­‰çº§${i}`] = 0;
            }

            renderEquipmentList();
            updateCalculations();
        }

        // æ¸²æŸ“è£…å¤‡åˆ—è¡¨
        function renderEquipmentList() {
            const container = document.getElementById('equipmentList');
            container.innerHTML = '';

            Object.keys(equipmentData).forEach(level => {
                const data = equipmentData[level];
                const currentValue = currentValues[level];
                const minValue = parseInt(data.å¼€å§‹å¼ºåŒ–);
                const maxValue = parseInt(data.ç»“æŸå¼ºåŒ–);

                const item = document.createElement('div');
                item.className = 'bg-gray-50 dark:bg-gray-700 rounded-lg p-4';
                item.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="font-semibold text-lg">${level}</span>
                                <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded text-sm">
                                    ${minValue}-${maxValue}%
                                </span>
                                <span class="text-sm text-gray-600 dark:text-gray-400">
                                    ${data.å…ƒå® !== "0" ? `${data.å…ƒå®}å…ƒå®` : `${data.çµç‰}çµç‰`}
                                </span>
                            </div>
                            <div class="flex items-center gap-4">
                                <label class="text-sm text-gray-600 dark:text-gray-400 min-w-0">å½“å‰å¼ºåŒ–:</label>
                                <input type="range"
                                        id="slider-${level}"
                                        min="0"
                                        max="${maxValue}"
                                        value="${currentValue}"
                                        class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-600 slider">
                                <span class="min-w-0 text-lg font-semibold text-primary" id="value-${level}">
                                    ${currentValue === 0 ? 'æœªå¼ºåŒ–' : `${currentValue}%`}
                                </span>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(item);

                // æ·»åŠ äº‹ä»¶ç›‘å¬
                const slider = document.getElementById(`slider-${level}`);
                slider.addEventListener('input', (e) => {
                    let value = parseInt(e.target.value);
                    if (value === 1) {
                        value = 2;
                        e.target.value = 2;
                    }
                    currentValues[level] = value;
                    document.getElementById(`value-${level}`).textContent = value === 0 ? 'æœªå¼ºåŒ–' : `${value}%`;
                    updateCalculations();
                });
            });
        }

        // æ¨èï¼šæ¯ä¸ªç­‰çº§åªä¿ç•™æ€§ä»·æ¯”æœ€é«˜çš„æå‡ï¼ˆâ‰¥1%ï¼‰ï¼ŒæŒ‰æ¯æå‡1%æœŸæœ›æˆæœ¬æ’åº
        function calculateFlexiblePercentRecommendations() {
            const allResults = [];
            const maxLevel = parseInt(document.getElementById('lightEffect').value) || 20;
            const yuanbaoRatio = parseInt(document.getElementById('yuanbaoRatio').value) || 30;

            Object.keys(equipmentData).forEach(level => {
                const levelNum = parseInt(level.replace('ç­‰çº§', ''));
                if (levelNum > maxLevel) return;

                const data = equipmentData[level];
                const currentValue = currentValues[level];
                const minValue = parseInt(data.å¼€å§‹å¼ºåŒ–);
                const maxValue = parseInt(data.ç»“æŸå¼ºåŒ–);

                if (currentValue >= maxValue) return;

                const cost = parseInt(data.å…ƒå®) + parseInt(data.çµç‰) * yuanbaoRatio;

                for (let nextValue = Math.max(minValue, currentValue + 1); nextValue <= maxValue; nextValue++) {
                    const gain = nextValue - currentValue;
                    if (gain < 1) continue;

                    const possibleValues = [];
                    for (let v = minValue; v <= maxValue; v++) {
                        possibleValues.push(v);
                    }
                    const probability = possibleValues.includes(nextValue) ? 1 / possibleValues.length : 0;
                    const expectedCost = probability > 0 ? cost / probability : 0;
                    const costPerPercent = expectedCost / gain;

                    allResults.push({
                        level,
                        currentValue,
                        nextValue,
                        gain,
                        cost,
                        probability,
                        expectedCost,
                        costPerPercent,
                        minValue,
                        maxValue,
                        data
                    });
                }
            });

            const bestResults = {};
            allResults.forEach(item => {
                if (!bestResults[item.level] || item.costPerPercent < bestResults[item.level].costPerPercent) {
                    bestResults[item.level] = item;
                }
            });

            const results = Object.values(bestResults);
            results.sort((a, b) => a.costPerPercent - b.costPerPercent);

            return results.slice(0, 3);
        }

        // æ›´æ–°æ¨è
        function updateRecommendations() {
            const recommendations = calculateFlexiblePercentRecommendations();
            const container = document.getElementById('recommendations');
            const yuanbaoRatio = parseInt(document.getElementById('yuanbaoRatio').value) || 30;

            if (recommendations.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400">æš‚æ— æ¨èé¡¹ç›®</div>';
                return;
            }

            container.innerHTML = '';

            recommendations.forEach((item, index) => {
                const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index];
                const borderColor = ['border-yellow-400', 'border-gray-400', 'border-amber-600'][index];

                const levelNum = parseInt(item.level.replace('ç­‰çº§', ''));
                let costUnit = 'å…ƒå®';
                let displayedExpectedCost = item.expectedCost;
                let displayedCostPerPercent = item.costPerPercent;
                if (levelNum > 10) {
                    costUnit = 'çµç‰';
                    displayedExpectedCost = item.expectedCost / yuanbaoRatio;
                    displayedCostPerPercent = item.costPerPercent / yuanbaoRatio;
                }

                const card = document.createElement('div');
                card.className = `border-2 ${borderColor} rounded-lg p-4 bg-gradient-to-br from-white to-gray-50 dark:from-gray-700 dark:to-gray-800`;

                card.innerHTML = `
                    <div class="text-center mb-3">
                        <div class="text-2xl mb-1">${medal}</div>
                        <div class="font-bold text-lg">${item.level}</div>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">å½“å‰å¼ºåŒ–:</span>
                            <span class="font-semibold">${item.currentValue}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">æœ¬æ¬¡æå‡:</span>
                            <span class="font-semibold">+${item.gain}% (${item.nextValue}%)</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">æ¦‚ç‡:</span>
                            <span class="font-semibold">${(item.probability * 100).toFixed(2)}%</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">æœŸæœ›æˆæœ¬:</span>
                            <span class="font-semibold">${displayedExpectedCost.toFixed(0)}${costUnit}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-600 dark:text-gray-400">æ¯æå‡1%æœŸæœ›æˆæœ¬:</span>
                            <span class="font-bold text-primary">${displayedCostPerPercent.toFixed(0)}${costUnit}</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // æ˜¾ç¤ºé¡¶éƒ¨ä¸‹æ‹‰æç¤º
        function showToast(message, type) {
            clearTimeout(toastTimeout);

            const toastContainer = document.getElementById('toast-container');
            const toastMessage = document.getElementById('toast-message');

            toastMessage.textContent = message;
            let bgColor = 'bg-gray-800';
            let textColor = 'text-white';
            if (type === 'success') {
                bgColor = 'bg-green-500';
                textColor = 'text-white';
            } else if (type === 'warning') {
                bgColor = 'bg-yellow-500';
                textColor = 'text-white';
            }
            toastMessage.className = `mx-auto max-w-lg p-3 rounded-lg text-center font-bold shadow-lg ${bgColor} ${textColor}`;

            toastContainer.classList.remove('hide');
            toastContainer.classList.add('show');

            toastTimeout = setTimeout(() => {
                toastContainer.classList.remove('show');
                toastContainer.classList.add('hide');
            }, 5000);
        }

        // æ›´æ–°è®¡ç®—
        function updateCalculations() {
            const currentSum = Object.values(currentValues).reduce((sum, value) => sum + value, 0);
            const targetSum = parseInt(document.getElementById('targetSum').value) || 0;
            const needSum = Math.max(0, targetSum - currentSum);

            document.getElementById('currentSum').textContent = currentSum;
            document.getElementById('needSum').textContent = needSum;

            updateRecommendations();

            if (currentSum >= targetSum && targetSum > 0) {
                showToast('ğŸ‰ å·²è¾¾æˆç›®æ ‡ï¼', 'success');
            }

            const lightEffect = document.getElementById('lightEffect').value;
            let maxLevel = parseInt(lightEffect) || 20;
            let maxSum = 0;
            for (let i = 1; i <= maxLevel; i++) {
                maxSum += parseInt(equipmentData[`ç­‰çº§${i}`].ç»“æŸå¼ºåŒ–);
            }

            if (targetSum > maxSum) {
                showToast(`âš ï¸ ç›®æ ‡è¶…å‡ºå½“å‰å…‰æ•ˆæœ€å¤§å¯è¾¾æˆæ•°å€¼ï¼ˆ${maxSum}%ï¼‰ï¼Œè¯·é™ä½ç›®æ ‡æˆ–æ›´æ¢å…‰æ•ˆï¼`, 'warning');
            }
        }

        document.getElementById('targetSum').addEventListener('blur', updateCalculations);
        document.getElementById('yuanbaoRatio').addEventListener('blur', updateCalculations);
        document.getElementById('lightEffect').addEventListener('change', () => {
            renderEquipmentList();
            updateCalculations();
        });

        init();
    </script>
</body>

</html>